# Jobson

[![Build Status](https://travis-ci.org/adamkewley/jobson.svg?branch=master)](https://travis-ci.org/adamkewley/jobson)

Jobson is a web server that can turn command-line applications into
a job system that manages:

- Authentication (guest, HTTP Basic, custom)
- Input collection & validation
- Request IDing, persistence, queueing, and timestamping
- Server-side execution (`fork(2)`)
- Realtime output forwarding (via websockets)
- Output persistence (stdout, stderr, files)


Video explanation:

[![Jobson Screencast](https://img.youtube.com/vi/W9yfpqWiyUg/0.jpg)](https://www.youtube.com/watch?v=W9yfpqWiyUg)


All Jobson needs is a YAML file that describes the application:

```yaml
name: Trivial Application

description: >

  Echoes supplied message to stdout


expectedInputs:

- id: message
  type: string
  name: Message
  description: The message to echo
  default: Hello, world!


execution:
  application: echo
  arguments:
  - ${inputs.message}
```

Jobson was developed to generate a standard HTTP API that is simple,
can be changed *very* easily (via spec files), and contains enough
information (names, descriptions) for frontends to provide a decent
user experience.

[Jobson UI](https://github.com/adamkewley/jobson-ui), a sister project,
automatically generates a full web frontend from the Jobson API.


# Install

- Ensure you have `java` installed. For example, on debian distros:

```
sudo apt-get install default-jre
```

- Download a [release](https://github.com/adamkewley/jobson/releases) of Jobson
- If a package is available for your platform (e.g. `jobson-x.x.x.deb` on debian distros), 
  install that.
- Otherwise, [manually install](#manual-install) Jobson


# Boot the Server

This generates an **unauthenticated** standard deployment with a demo job spec:

```bash
jobson new --demo
jobson serve config.yml
```

See [API examples](#using-the-api) to play with the HTTP API or, better, host a
[Jobson UI](https://github.com/adamkewley/jobson-ui) so you can *see* the
API. If you want something more comprehensive then see 
[more jobson deployment examples](#more-jobson-deployment-examples).


# Add Job Specs
From a Jobson deployment folder (generated by `jobson new`), a new spec can be 
generated with:

```bash
jobson generate spec my-new-spec
```

Which will generate a demo spec in the specs folder (by default: `specs/my-new-spec/spec.yml`).
Edit that spec file to your liking.


# Using the API
Jobson will echo the full HTTP API into the console when the server boots.

## cURL

If you are using `basic` auth, add credentials to each of these examples with `--user`.
For example:

```bash
curl --user someuser:somepassword localhost:8080/v1/jobs
```

```bash
curl --data @job-request.json localhost:8080/v1/jobs

# view/query jobs
curl localhost:8080/v1/jobs
curl localhost:8080/v1/jobs?query=somejobname
curl localhost:8080/v1/jobs?query=somejobname&page=1&pagesize=10

# view a specific job
curl localhost:8080/v1/jobs/{id}
curl localhost:8080/v1/jobs/{id}/inputs
curl localhost:8080/v1/jobs/{id}/stdout
curl localhost:8080/v1/jobs/{id}/stderr
curl localhost:8080/v1/jobs/{id}/outputs
curl localhost:8080/v1/jobs/{id}/outputs/{output-id}
curl localhost:8080/v1/jobs/{id}/spec

# view spec(s)
curl localhost:8080/v1/specs
curl localhost:8080/v1/specs/{spec-id}

# get current user ID
curl --user someuser:somepassword localhost:8080/v1/users/current
```


## Javascript
In a web browser:

```javascript
var req = new XMLHttpRequest();
req.open("GET", "http://localhost:8080/v1/jobs");
// If basic auth enabled, and you don't want the browser to prompt users:
req.setRequestHeader("Authorization", "Basic " + btoa("exampleuser:password"));
req.send();
```


# More Jobson Deployment Examples

## Standard Deployment /w Basic Auth

This generates an authenticated standard deployment with your own spec.

```bash
jobson new

# edit config.yml to use basic auth

# with basic auth enabled, you need to add a user
jobson users add -p password exampleuser

jobson generate spec trivial

# edit specs/trivial/spec.yml

jobson serve config.yml
```

## Standard Deployment /w Basic Auth and Spec Validation

Same as above, but with debugging.

```bash
jobson new

# edit config.yml to use basic auth

jobson users add -p password exampleuser

jobson generate spec trivial

# edit specs/trivial/spec.yml

# check for basic errors
jobson validate spec trivial

# generate a request that would be sent to the Jobson API
jobson generate request trivial > dummy-req.json

# edit dummy-req.json

# run the application locally, as if it were ran by the full Jobson stack
jobson run dummy-req.json

# assuming everything looks ok:
jobson serve config.yml
```


# Manual Install

- If a package is *not* available for your platform then you will need to 
  manually install Jobson.
- Download a binary release (i.e. `jobson-x.x.x-bin.tar.gz`) from 
  [releases](https://github.com/adamkewley/jobson/releases)
- Unzip the `jobson` runscript and `jobson-x.x.x.jar` runtime from the archive
- You should now be able to run jobson locally (e.g. `./jobson new --demo`)

If you want to install install Jobson system-wide:

- Put the `.jar` file wherever your OS puts jar files (usually, `/usr/share/java`)
- Edit the `jobson` runscript to point to that jar (that is, replace `-jar $(dirname $0)/jobson.jar` 
  with `-jar wherever/you/put/jobson.jar`)
- Add the `jobson` runscript to wherever your OS puts user-installed executables
  (usually, `/usr/local/bin`)
- You're done - you should now be able to run `jobson`

See [troubleshooting](#troubleshooting) if these steps did not work for you.


# Build

Built with `Maven` and `JDK 1.8+`. From the project directory:

```bash
mvn package
```

This will put the release files in `target/`.


# Troubleshooting

## Install

- If you get errors like `jobson: command not found` then the runscript is not
  on the `PATH` (ensure it's installed in the right place and reset your 
  CLI client)
- If you get errors like `java: command not found` then java isn't installed
- If you get errors like `Error: Unable to access jarfile ...` then the path
  provided to `-jar` (above) may be invalid or the permissions are too strict.
  
## API

- If the API is responding with internal server errors, check the Jobson server's
  logs. 99 % of the time, it's because a job spec is malformed (yes, I know, this should
  probably be made clear in the HTTP API as well).
